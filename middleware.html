<!DOCTYPE html />

<html>
<head>
    <title>Middleware.fs</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link href="focco.css" rel="stylesheet" media="all" type="text/css" />
    <script src="prettify.js" type="text/javascript"></script>
</head>
<body onload="prettyPrint()">
    <div id="container">
        <div id="background"></div>
            <div id="jump_to">
                Jump To &hellip;
                <div id="jump_wrapper">
                    <div id="jump_page">
                        <a class="source" href="assemblyinfo.html">
                            AssemblyInfo.fs
                        </a>
                        <a class="source" href="index.html">
                            Frank.fs
                        </a>
                        <a class="source" href="hosting.html">
                            Hosting.fs
                        </a>
                        <a class="source" href="middleware.html">
                            Middleware.fs
                        </a>
                    </div>
                </div>
            </div>
        <table cellpadding="0" cellspacing="0">
            <thead>
                <tr>
                    <th class="docs">
                        <h1>Middleware.fs</h1>
                    </th>
                    <th class="code"></th>
                </tr>
            </thead>
            <tbody>
                <tr id="section_1">
                    <td class="docs">
                        <div class="pilwrap">
                            <a class="pilcrow" href="#section_1">&#182;</a>
                        </div>
                        <h1>Frank.Middleware</h1>

<h2>License</h2>

<p>Author: Ryan Riley <a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#111;:&#114;&#121;&#x61;n&#x2e;&#114;&#x69;&#108;&#x65;&#x79;&#64;&#112;&#97;&#110;&#101;&#115;&#111;&#x66;&#x67;&#x6c;&#97;&#x73;s.&#x6f;&#x72;&#103;">&#114;&#121;&#x61;n&#x2e;&#114;&#x69;&#108;&#x65;&#x79;&#64;&#112;&#97;&#110;&#101;&#115;&#111;&#x66;&#x67;&#x6c;&#97;&#x73;s.&#x6f;&#x72;&#103;</a>
Copyright (c) 2011, Ryan Riley.</p>

<p>Licensed under the Apache License, Version 2.0.
See LICENSE.txt for details.</p>

                    </td>
                    <td class="code">
                        <pre><code class='prettyprint'>module Frank.Middleware

open System
open System.Collections.Generic
open System.Json
open System.Net.Http
open Microsoft.ApplicationServer.Http
open Frank
open ImpromptuInterface.FSharp

</code></pre>
                    </td>
                </tr>
                <tr id="section_2">
                    <td class="docs">
                        <div class="pilwrap">
                            <a class="pilcrow" href="#section_2">&#182;</a>
                        </div>
                        <p>TODO: add diagnostics and logging
TODO: add messages to access diagnostics and logging info from the agent</p>

                    </td>
                    <td class="code">
                        <pre><code class='prettyprint'>  
let log app =
  fun (request: HttpRequestMessage) content -&gt; async {
    let sw = System.Diagnostics.Stopwatch.StartNew()
    let! response = app request content
    printfn &quot;Received a %A request from %A. Responded in %i ms.&quot;
            request.Method.Method request.RequestUri.PathAndQuery sw.ElapsedMilliseconds
    sw.Reset()
    return response }

let head app =
  fun (request: HttpRequestMessage) content -&gt;
    if request.Method = HttpMethod.Head then 
      async {
        request.Method &lt;- HttpMethod.Get
        let! (response : HttpResponseMessage) = app request content
        let emptyContent = HttpContent.Empty
        for KeyValue(header, value) in response.Content.Headers do
          emptyContent.Headers.Add(header, value)
        return response }
    else app request content

let private overridableHttpMethods =
  [ HttpMethod.Delete
    HttpMethod.Get
    HttpMethod.Head
    HttpMethod.Options
    HttpMethod.Put
    HttpMethod.Trace ]

let methodOverride app =
</code></pre>
                    </td>
                </tr>
                <tr id="section_3">
                    <td class="docs">
                        <div class="pilwrap">
                            <a class="pilcrow" href="#section_3">&#182;</a>
                        </div>
                        <p>Leave out POST, as that is the method we are overriding.</p>

                    </td>
                    <td class="code">
                        <pre><code class='prettyprint'>  fun (request : HttpRequestMessage) (content: HttpContent) -&gt; async {
    if request.Method = HttpMethod.Post &amp;&amp;
       request.Content.Headers.ContentType.MediaType &lt;&gt; &quot;application/x-http-form-urlencoded&quot; then
      let! value = Async.AwaitTask (content.ReadAsAsync&lt;JsonValue&gt;())
      let form = value.AsDynamic()
      let httpMethod =
        if (not &lt;&lt; String.IsNullOrEmpty) form?_method then
          new HttpMethod(form?_method)
        elif request.Content.Headers.Contains(&quot;HTTP_X_HTTP_METHOD_OVERRIDE&quot;) then
          let m = request.Content.Headers.GetValues(&quot;HTTP_X_HTTP_METHOD_OVERRIDE&quot;) |&gt; Seq.head in new HttpMethod(m)
        else request.Method
      if overridableHttpMethods |&gt; List.exists ((=) httpMethod) then
        request.Content.Headers.Add(&quot;methodoverride_original_method&quot;, httpMethod.Method)
        request.Method &lt;- HttpMethod.Post
    return! app request content }
</code></pre>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>
